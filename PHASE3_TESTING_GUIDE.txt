PHASE 3 TESTING GUIDE - Key Exchange Protocol
==============================================

This guide will help you test the key exchange protocol implementation.

PREREQUISITES:
--------------
1. Backend server running on port 3001
2. Frontend running on port 5173
3. MongoDB connected
4. At least 2 registered users (e.g., "user1" and "user2")

TESTING METHODS:
----------------

METHOD 1: Browser Console Testing (Recommended)
────────────────────────────────────────────────

Step 1: Open Browser Console
  - Open your frontend app (http://localhost:5173)
  - Open Developer Tools (F12 or Cmd+Option+I)
  - Go to Console tab

Step 2: Import Testing Functions
  - Copy and paste this into console:

```javascript
// Import key exchange functions
import('./src/utils/keyExchange.js').then(module => {
  window.keyExchange = module;
  console.log('✅ Key exchange functions loaded');
});

// Import API service
import('./src/services/api.js').then(module => {
  window.api = module.default;
  console.log('✅ API service loaded');
});

// Import key storage
import('./src/utils/keyStorage.js').then(module => {
  window.keyStorage = module;
  console.log('✅ Key storage loaded');
});
```

Step 3: Test Key Exchange Flow

A. Get User IDs (you need these from your database or registration response)
   - Check localStorage: localStorage.getItem('userId')
   - Or get from MongoDB

B. Test Initiation (User 1 initiates with User 2)
```javascript
// Replace with actual user IDs and username
const fromUserId = 'YOUR_USER1_ID';
const toUserId = 'YOUR_USER2_ID';
const username = 'user1';

// Initiate key exchange
keyExchange.initiateKeyExchange(fromUserId, toUserId, username)
  .then(result => {
    console.log('✅ Key exchange initiated:', result);
    window.exchangeId = result.exchangeId;
    window.ephemeralKeyPair = result.ephemeralKeyPair;
    window.nonce = result.nonce;
  })
  .catch(error => console.error('❌ Error:', error));
```

C. Test Response (User 2 responds)
```javascript
// First, get pending exchanges for User 2
api.get(`/key-exchange/pending/${toUserId}`)
  .then(res => {
    console.log('Pending exchanges:', res.data);
    const exchange = res.data.exchanges[0];
    
    // Get User 1's public key
    return api.get(`/users/username/${username}/public-key`)
      .then(keyRes => {
        const initiatorRSAKey = keyRes.data.publicKey;
        
        // Respond to key exchange
        return keyExchange.respondToKeyExchange(
          exchange.exchangeId,
          exchange.fromUserId._id || exchange.fromUserId,
          toUserId,
          'user2', // User 2's username
          exchange.initiatorEphemeralPublicKey,
          exchange.initiatorSignature,
          initiatorRSAKey
        );
      });
  })
  .then(result => {
    console.log('✅ Key exchange responded:', result);
    window.sessionKey = result.sessionKey;
  })
  .catch(error => console.error('❌ Error:', error));
```

D. Test Completion (User 1 completes)
```javascript
// Get the response from server
api.get(`/key-exchange/${window.exchangeId}`)
  .then(res => {
    const exchange = res.data.keyExchange;
    
    // Get User 2's public key
    return api.get(`/users/${toUserId}/public-key`)
      .then(keyRes => {
        const responderRSAKey = keyRes.data.publicKey;
        
        // Complete key exchange
        return keyExchange.completeKeyExchange(
          window.exchangeId,
          fromUserId,
          toUserId,
          window.ephemeralKeyPair,
          exchange.responderEphemeralPublicKey,
          exchange.keyConfirmation,
          exchange.nonce,
          exchange.responderSignature,
          responderRSAKey
        );
      });
  })
  .then(sessionKey => {
    console.log('✅ Key exchange completed! Session key:', sessionKey);
    console.log('✅ Both users now have the same session key');
  })
  .catch(error => console.error('❌ Error:', error));
```

E. Verify Session Key Storage
```javascript
// Check if session key is stored
keyStorage.getSessionKey(window.exchangeId)
  .then(key => {
    console.log('✅ Session key retrieved from storage');
    console.log('Key algorithm:', key.algorithm);
  })
  .catch(error => console.error('❌ Error:', error));
```


METHOD 2: API Endpoint Testing (Using curl or Postman)
───────────────────────────────────────────────────────

Test 1: Initiate Key Exchange
──────────────────────────────
POST http://localhost:3001/api/key-exchange/initiate
Content-Type: application/json

{
  "fromUserId": "USER1_ID",
  "toUserId": "USER2_ID",
  "ephemeralPublicKey": "BASE64_ENCODED_ECDH_PUBLIC_KEY",
  "timestamp": 1234567890,
  "nonce": "BASE64_ENCODED_NONCE",
  "signature": "BASE64_ENCODED_SIGNATURE"
}

Expected Response:
{
  "success": true,
  "exchangeId": "uuid-here",
  "message": "Key exchange initiated"
}

Test 2: Get Pending Exchanges
──────────────────────────────
GET http://localhost:3001/api/key-exchange/pending/USER2_ID

Expected Response:
{
  "success": true,
  "exchanges": [...]
}

Test 3: Respond to Key Exchange
───────────────────────────────
POST http://localhost:3001/api/key-exchange/respond
Content-Type: application/json

{
  "exchangeId": "EXCHANGE_ID",
  "ephemeralPublicKey": "BASE64_ENCODED_ECDH_PUBLIC_KEY",
  "keyConfirmation": "BASE64_ENCODED_HMAC",
  "timestamp": 1234567890,
  "nonce": "BASE64_ENCODED_NONCE",
  "signature": "BASE64_ENCODED_SIGNATURE"
}

Test 4: Confirm Key Exchange
────────────────────────────
POST http://localhost:3001/api/key-exchange/confirm
Content-Type: application/json

{
  "exchangeId": "EXCHANGE_ID",
  "confirmed": true
}

Test 5: Get Key Exchange Details
─────────────────────────────────
GET http://localhost:3001/api/key-exchange/EXCHANGE_ID


METHOD 3: Create a Simple Test UI Component
────────────────────────────────────────────

You can create a test component in your React app to test the key exchange.

Create: frontend/src/components/KeyExchangeTest.jsx

```jsx
import { useState } from 'react';
import * as keyExchange from '../utils/keyExchange';
import api from '../services/api';

const KeyExchangeTest = () => {
  const [fromUserId, setFromUserId] = useState('');
  const [toUserId, setToUserId] = useState('');
  const [username, setUsername] = useState('');
  const [result, setResult] = useState('');

  const testInitiate = async () => {
    try {
      const result = await keyExchange.initiateKeyExchange(
        fromUserId,
        toUserId,
        username
      );
      setResult(JSON.stringify(result, null, 2));
    } catch (error) {
      setResult('Error: ' + error.message);
    }
  };

  return (
    <div style={{ padding: '20px' }}>
      <h2>Key Exchange Test</h2>
      <input
        placeholder="From User ID"
        value={fromUserId}
        onChange={(e) => setFromUserId(e.target.value)}
      />
      <input
        placeholder="To User ID"
        value={toUserId}
        onChange={(e) => setToUserId(e.target.value)}
      />
      <input
        placeholder="Username"
        value={username}
        onChange={(e) => setUsername(e.target.value)}
      />
      <button onClick={testInitiate}>Test Initiate</button>
      <pre>{result}</pre>
    </div>
  );
};

export default KeyExchangeTest;
```


VERIFICATION CHECKLIST:
────────────────────────

✓ Key Exchange Initiation
  - Ephemeral ECDH key pair generated
  - Message signed correctly
  - Server stores exchange record
  - Exchange ID returned

✓ Signature Verification
  - Initiator's signature verifies correctly
  - Responder's signature verifies correctly
  - Invalid signatures are rejected

✓ Key Derivation
  - Shared secret derived correctly (ECDH)
  - Session key derived correctly (HKDF)
  - Both parties get the same key

✓ Key Confirmation
  - HMAC generated correctly
  - HMAC verification passes
  - Invalid HMAC is rejected

✓ Session Key Storage
  - Session key stored in IndexedDB
  - Session key can be retrieved
  - Session key expires correctly

✓ Database Records
  - Key exchange records created
  - Status updates correctly
  - Expiration works


COMMON ISSUES & SOLUTIONS:
──────────────────────────

Issue: "Private key not found"
Solution: Make sure user is logged in and has registered

Issue: "Signature verification failed"
Solution: Check that you're using the correct public key for verification

Issue: "Key confirmation failed"
Solution: Ensure both parties use the same nonce and derive keys in the same order

Issue: "Exchange not found"
Solution: Check that exchangeId is correct and exchange hasn't expired

Issue: "CORS errors"
Solution: Make sure backend is running and CORS is configured correctly


TESTING WITH TWO BROWSER WINDOWS:
──────────────────────────────────

1. Open two browser windows (or use incognito)
2. Register/login as User 1 in Window 1
3. Register/login as User 2 in Window 2
4. In Window 1: Initiate key exchange with User 2
5. In Window 2: Check pending exchanges and respond
6. In Window 1: Complete the key exchange
7. Verify both have the same session key

This simulates real-world usage where two different users
establish a secure channel.

